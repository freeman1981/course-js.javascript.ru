(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{10:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var a=s(9);function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{constructor(e=[],{url:t="",sorted:s={id:e.find(e=>e.sortable).id,order:"asc"},isSortLocally:a=!1,step:r=20,start:i=1,end:o=i+r,from:l=null,to:c=null,filtered:d=null}={}){n(this,"element",void 0),n(this,"subElements",{}),n(this,"data",[]),n(this,"loading",!1),n(this,"step",20),n(this,"start",1),n(this,"end",this.start+this.step),n(this,"onWindowScroll",async()=>{const{bottom:e}=this.element.getBoundingClientRect(),{id:t,order:s}=this.sorted;if(e<document.documentElement.clientHeight&&!this.loading&&!this.isSortLocally){this.start=this.end,this.end=this.start+this.step,this.loading=!0;const e=await this.loadData(t,s,this.start,this.end);this.update(e),this.loading=!1}}),n(this,"onSortClick",e=>{const t=e.target.closest('[data-sortable="true"]');if(t){const{id:e,order:s}=t.dataset,a=(e=>({asc:"desc",desc:"asc"}[e]))(s);this.sorted={id:e,order:a},t.dataset.order=a,t.append(this.subElements.arrow),this.isSortLocally?this.sortLocally(e,a):(this.start=1,this.end=1+this.step,this.sortOnServer(e,a,this.start,this.end))}}),this.headersConfig=e,this.url=new URL(t,"https://course-js.javascript.ru/"),this.sorted=s,this.isSortLocally=a,this.step=r,this.start=i,this.end=o,this.from=l,this.to=c,this.filtered=d,this.render()}async render(){const{id:e,order:t}=this.sorted,s=document.createElement("div");s.innerHTML=this.getTable();const a=s.firstElementChild;this.element=a,this.subElements=this.getSubElements(a);const n=await this.loadData(e,t,this.start,this.end);return this.renderRows(n),this.initEventListeners(),this.element}async loadData(e,t,s=this.start,n=this.end){if(this.from&&this.to&&(this.url.searchParams.set("createdAt_gte",this.from),this.url.searchParams.set("createdAt_lte",this.to)),this.filtered){const{price_gte:e,price_lte:t,title_like:s,status:a}=this.filtered;this.url.searchParams.set("price_gte",e),this.url.searchParams.set("price_lte",t),s&&this.url.searchParams.set("title_like",s),a&&this.url.searchParams.set("status",a)}this.url.searchParams.set("_sort",e),this.url.searchParams.set("_order",t),this.url.searchParams.set("_start",s),this.url.searchParams.set("_end",n),this.element.classList.add("sortable-table_loading");const r=await Object(a.a)(this.url);return this.element.classList.remove("sortable-table_loading"),r}addRows(e){this.data=e,this.subElements.body.innerHTML=this.getTableRows(e),e.length?this.element.classList.remove("sortable-table_empty"):this.element.classList.add("sortable-table_empty")}update(e){const t=document.createElement("div");return this.data=[...this.data,...e],t.innerHTML=this.getTableRows(e),this.subElements.body.append(...t.childNodes),t}getTableHeader(){return'<div data-element="header" class="sortable-table__header sortable-table__row">\n      '.concat(this.headersConfig.map(e=>this.getHeaderRow(e)).join(""),"\n    </div>")}getHeaderRow({id:e,title:t,sortable:s}){const a=this.sorted.id===e?this.sorted.order:"asc";return'\n      <div class="sortable-table__cell" data-id="'.concat(e,'" data-sortable="').concat(s,'" data-order="').concat(a,'">\n        <span>').concat(t,"</span>\n        ").concat(this.getHeaderSortingArrow(e),"\n      </div>\n    ")}getHeaderSortingArrow(e){return(this.sorted.id===e?this.sorted.order:"")?'<span data-element="arrow" class="sortable-table__sort-arrow">\n          <span class="sort-arrow"></span>\n        </span>':""}getTableBody(e){return'\n      <div data-element="body" class="sortable-table__body">\n        '.concat(this.getTableRows(e),"\n      </div>")}getTableRows(e){return e.map(t=>'\n      <a href="/products/'.concat(t.id,'" class="sortable-table__row">\n        ').concat(this.getTableRow(t,e),"\n      </a>")).join("")}getTableRow(e){return this.headersConfig.map(({id:e,template:t})=>({id:e,template:t})).map(({id:t,template:s})=>s?s(e[t]):'<div class="sortable-table__cell">'.concat(e[t],"</div>")).join("")}getTable(){return'\n      <div class="sortable-table">\n        '.concat(this.getTableHeader(),"\n        ").concat(this.getTableBody(this.data),'\n\n        <div data-element="loading" class="loading-line sortable-table__loading-line"></div>\n\n        <div data-element="emptyPlaceholder" class="sortable-table__empty-placeholder">\n          No data\n        </div>\n      </div>')}initEventListeners(){this.subElements.header.addEventListener("pointerdown",this.onSortClick),document.addEventListener("scroll",this.onWindowScroll)}sortLocally(e,t){const s=this.sortData(e,t);this.subElements.body.innerHTML=this.getTableBody(s)}async sortOnServer(e,t,s,a){const n=await this.loadData(e,t,s,a);this.renderRows(n)}renderRows(e){e.length?(this.element.classList.remove("sortable-table_empty"),this.addRows(e)):this.element.classList.add("sortable-table_empty")}sortData(e,t){const s=[...this.data],a=this.headersConfig.find(t=>t.id===e),{sortType:n,customSorting:r}=a,i="asc"===t?1:-1;return s.sort((t,s)=>{switch(n){case"number":return i*(t[e]-s[e]);case"string":return i*t[e].localeCompare(s[e],"ru");case"custom":return i*r(t,s);default:return i*(t[e]-s[e])}})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}remove(){this.element.remove(),document.removeEventListener("scroll",this.onWindowScroll)}destroy(){this.remove(),this.subElements={}}}},14:function(e,t,s){"use strict";function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,"a",(function(){return n}));class n{static formatDate(e){return e.toLocaleString("ru",{dateStyle:"short"})}constructor({from:e=new Date,to:t=new Date}={}){a(this,"element",null),a(this,"subElements",{}),a(this,"selectingFrom",!0),a(this,"selected",{from:new Date,to:new Date}),a(this,"onDocumentClick",e=>{const t=this.element.classList.contains("rangepicker_open"),s=this.element.contains(e.target);t&&!s&&this.close()}),this.showDateFrom=new Date(e),this.selected={from:e,to:t},this.render()}get template(){const e=n.formatDate(this.selected.from),t=n.formatDate(this.selected.to);return'<div class="rangepicker">\n      <div class="rangepicker__input" data-elem="input">\n        <span data-elem="from">'.concat(e,'</span> -\n        <span data-elem="to">').concat(t,'</span>\n      </div>\n      <div class="rangepicker__selector" data-elem="selector"></div>\n    </div>')}render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(e),this.initEventListeners(),Promise.resolve(this.element)}getSubElements(e){const t={};for(const s of e.querySelectorAll("[data-elem]"))t[s.dataset.elem]=s;return t}initEventListeners(){const{input:e,selector:t}=this.subElements;document.addEventListener("click",this.onDocumentClick,!0),e.addEventListener("click",()=>this.toggle()),t.addEventListener("click",e=>this.onSelectorClick(e))}toggle(){this.element.classList.toggle("rangepicker_open"),this.renderDateRangePicker()}onSelectorClick({target:e}){e.classList.contains("rangepicker__cell")&&this.onRangePickerCellClick(e)}close(){this.element.classList.remove("rangepicker_open")}renderDateRangePicker(){const e=new Date(this.showDateFrom),t=new Date(this.showDateFrom),{selector:s}=this.subElements;t.setMonth(t.getMonth()+1),s.innerHTML='\n      <div class="rangepicker__selector-arrow"></div>\n      <div class="rangepicker__selector-control-left"></div>\n      <div class="rangepicker__selector-control-right"></div>\n      '.concat(this.renderCalendar(e),"\n      ").concat(this.renderCalendar(t),"\n    ");const a=s.querySelector(".rangepicker__selector-control-left"),n=s.querySelector(".rangepicker__selector-control-right");a.addEventListener("click",()=>this.prev()),n.addEventListener("click",()=>this.next()),this.renderHighlight()}prev(){this.showDateFrom.setMonth(this.showDateFrom.getMonth()-1),this.renderDateRangePicker()}next(){this.showDateFrom.setMonth(this.showDateFrom.getMonth()+1),this.renderDateRangePicker()}renderHighlight(){const{from:e,to:t}=this.selected;for(const s of this.element.querySelectorAll(".rangepicker__cell")){const{value:a}=s.dataset,n=new Date(a);s.classList.remove("rangepicker__selected-from"),s.classList.remove("rangepicker__selected-between"),s.classList.remove("rangepicker__selected-to"),e&&a===e.toISOString()?s.classList.add("rangepicker__selected-from"):t&&a===t.toISOString()?s.classList.add("rangepicker__selected-to"):e&&t&&n>=e&&n<=t&&s.classList.add("rangepicker__selected-between")}if(e){const t=this.element.querySelector('[data-value="'.concat(e.toISOString(),'"]'));t&&t.closest(".rangepicker__cell").classList.add("rangepicker__selected-from")}if(t){const e=this.element.querySelector('[data-value="'.concat(t.toISOString(),'"]'));e&&e.closest(".rangepicker__cell").classList.add("rangepicker__selected-to")}}renderCalendar(e){const t=new Date(e);t.setDate(1);const s=t.toLocaleString("ru",{month:"long"});let a='<div class="rangepicker__calendar">\n      <div class="rangepicker__month-indicator">\n        <time datetime='.concat(s,">").concat(s,'</time>\n      </div>\n      <div class="rangepicker__day-of-week">\n        <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>\n      </div>\n      <div class="rangepicker__date-grid">\n    ');var n;for(a+='\n      <button type="button"\n        class="rangepicker__cell"\n        data-value="'.concat(t.toISOString(),'"\n        style="--start-from: ').concat((n=t.getDay(),1+(0===n?6:n-1)),'">\n          ').concat(t.getDate(),"\n      </button>"),t.setDate(2);t.getMonth()===e.getMonth();)a+='\n        <button type="button"\n          class="rangepicker__cell"\n          data-value="'.concat(t.toISOString(),'">\n            ').concat(t.getDate(),"\n        </button>"),t.setDate(t.getDate()+1);return a+="</div></div>",a}onRangePickerCellClick(e){const{value:t}=e.dataset;if(t){const e=new Date(t);this.selectingFrom?(this.selected={from:e,to:null},this.selectingFrom=!1,this.renderHighlight()):(e>this.selected.from?this.selected.to=e:(this.selected.to=this.selected.from,this.selected.from=e),this.selectingFrom=!0,this.renderHighlight()),this.selected.from&&this.selected.to&&(this.dispatchEvent(),this.close(),this.subElements.from.innerHTML=n.formatDate(this.selected.from),this.subElements.to.innerHTML=n.formatDate(this.selected.to))}}dispatchEvent(){this.element.dispatchEvent(new CustomEvent("date-select",{bubbles:!0,detail:this.selected}))}remove(){this.element.remove(),document.removeEventListener("click",this.onDocumentClick,!0)}destroy(){return this.remove(),this.element=null,this.subElements={},this.selectingFrom=!0,this.selected={from:new Date,to:new Date},this}}},5:function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return d}));var a=s(14),n=s(10);function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class i{constructor({data:e=[],label:t="",link:s="",value:a=0}={}){r(this,"element",void 0),r(this,"subElements",{}),r(this,"chartHeight",50),this.data=e,this.label=t,this.link=s,this.value=a,this.render()}getColumnBody(e){const t=Math.max(...e);return e.map(e=>{const s=this.chartHeight/t,a=(e/t*100).toFixed(0);return'<div style="--value: '.concat(Math.floor(e*s),'" data-tooltip="').concat(a,'%"></div>')}).join("")}getLink(){return this.link?'<a class="column-chart__link" href="'.concat(this.link,'">View all</a>'):""}get template(){return'\n      <div class="column-chart column-chart_loading" style="--chart-height: '.concat(this.chartHeight,'">\n        <div class="column-chart__title">\n          Total ').concat(this.label,"\n          ").concat(this.getLink(),'\n        </div>\n        <div class="column-chart__container">\n          <div data-element="header" class="column-chart__header">\n            ').concat(this.value,'\n          </div>\n          <div data-element="body" class="column-chart__chart">\n            ').concat(this.getColumnBody(this.data),"\n          </div>\n        </div>\n      </div>\n    ")}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.element.classList.remove("column-chart_loading"),this.subElements=this.getSubElements(this.element),this.element}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}update({headerData:e,bodyData:t}){this.subElements.header.textContent=e,this.subElements.body.innerHTML=this.getColumnBody(t)}destroy(){this.element.remove()}}var o=[{id:"images",title:"Image",sortable:!1,template:e=>'\n          <div class="sortable-table__cell">\n            <img class="sortable-table-image" alt="Image" src="'.concat(e[0]?e[0].url:"",'">\n          </div>\n        ')},{id:"title",title:"Name",sortable:!0,sortType:"string"},{id:"quantity",title:"Quantity",sortable:!0,sortType:"number"},{id:"price",title:"Price",sortable:!0,sortType:"number"},{id:"status",title:"Status",sortable:!0,sortType:"number",template:e=>'<div class="sortable-table__cell">\n          '.concat(e>0?"Active":"Inactive","\n        </div>")}],l=s(9);function c(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class d{constructor(){c(this,"element",void 0),c(this,"subElements",{}),c(this,"components",{})}async getDataForColumnCharts(e,t){const s="".concat("https://course-js.javascript.ru/","api/dashboard/orders?from=").concat(e.toISOString(),"&to=").concat(t.toISOString()),a="".concat("https://course-js.javascript.ru/","api/dashboard/sales?from=").concat(e.toISOString(),"&to=").concat(t.toISOString()),n="".concat("https://course-js.javascript.ru/","api/dashboard/customers?from=").concat(encodeURIComponent(e.toISOString()),"&to=").concat(encodeURIComponent(t.toISOString())),r=Object(l.a)(s),i=Object(l.a)(a),o=Object(l.a)(n);return(await Promise.all([r,i,o])).map(e=>Object.values(e))}async updateTableComponent(e,t){this.updateCssClass(["sortableTable"],"add",["sortable-table_loading"]);const s=await Object(l.a)("".concat("https://course-js.javascript.ru/","api/dashboard/bestsellers?_start=1&_end=20&from=").concat(e.toISOString(),"&to=").concat(t.toISOString()));this.components.sortableTable.addRows(s),this.updateCssClass(["sortableTable"],"remove",["sortable-table_loading"])}async updateChartsComponents(e,t){const s=["ordersChart","salesChart","customersChart"],a=["column-chart_loading"];this.updateCssClass(s,"add",a);const[n,r,i]=await this.getDataForColumnCharts(e,t),o=n.reduce((e,t)=>e+t,0),l=r.reduce((e,t)=>e+t,0),c=i.reduce((e,t)=>e+t,0);this.components.ordersChart.update({headerData:o,bodyData:n}),this.components.salesChart.update({headerData:"$"+l,bodyData:r}),this.components.customersChart.update({headerData:c,bodyData:i}),this.updateCssClass(s,"remove",a)}updateCssClass(e,t,s){for(const a of e){const{element:e}=this.components[a];for(const a of s)switch(t){case"add":e.classList.add(a);break;case"remove":e.classList.remove(a)}}}async initComponents(){const e=new Date,t=new Date(e.getTime()-2592e6),[s,r,l]=await this.getDataForColumnCharts(t,e),c=new a.a({from:t,to:e}),d=new n.a(o,{url:"api/dashboard/bestsellers?_start=1&_end=20&from=".concat(t.toISOString(),"&to=").concat(e.toISOString()),isSortLocally:!0}),h=new i({data:s,label:"orders",value:s.reduce((e,t)=>e+t,0),link:"#"}),m=new i({data:r,label:"sales",value:"$"+r.reduce((e,t)=>e+t,0)}),u=new i({data:l,label:"customers",value:l.reduce((e,t)=>e+t,0)});this.components.sortableTable=d,this.components.ordersChart=h,this.components.salesChart=m,this.components.customersChart=u,this.components.rangePicker=c}get template(){return'<div class="dashboard">\n      <div class="content__top-panel">\n        <h2 class="page-title">Dashboard</h2>\n        \x3c!-- RangePicker component --\x3e\n        <div data-element="rangePicker"></div>\n      </div>\n      <div data-element="chartsRoot" class="dashboard__charts">\n        \x3c!-- column-chart components --\x3e\n        <div data-element="ordersChart" class="dashboard__chart_orders"></div>\n        <div data-element="salesChart" class="dashboard__chart_sales"></div>\n        <div data-element="customersChart" class="dashboard__chart_customers"></div>\n      </div>\n\n      <h3 class="block-title">Best sellers</h3>\n\n      <div data-element="sortableTable">\n        \x3c!-- sortable-table component --\x3e\n      </div>\n    </div>'}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),await this.initComponents(),this.renderComponents(),this.initEventListeners(),this.element}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:s}=this.components[e];t.append(s)})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}initEventListeners(){this.components.rangePicker.element.addEventListener("date-select",e=>{const{from:t,to:s}=e.detail;this.updateChartsComponents(t,s),this.updateTableComponent(t,s)})}destroy(){for(const e of Object.values(this.components))e.destroy()}}},9:function(e,t,s){"use strict";t.a=async function(e,t){let s,n;try{s=await fetch(e.toString(),t)}catch(e){throw new a(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{n=await s.json(),e=n.error&&n.error.message||n.data&&n.data.error&&n.data.error.message||e}catch(e){}let t="Error ".concat(s.status,": ").concat(e);throw new a(s,n,t)}try{return await s.json()}catch(e){throw new a(s,null,e.message)}};class a extends Error{constructor(e,t,s){var a,n,r;super(s),r="FetchError",(n="name")in(a=this)?Object.defineProperty(a,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):a[n]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof a&&alert(e.reason.message)})}}]);
//# sourceMappingURL=dashboard-index-js-2.js.map